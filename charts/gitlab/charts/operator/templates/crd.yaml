{{- if and .Values.global.operator.enabled .Values.install.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "fullname" . }}-crd-installer
  labels:
{{ include "gitlab.standardLabels" $ | indent 4 }}
  annotations:
    "helm.sh/hook-weight": "-3"
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      labels:
        app: {{ template "fullname" . }}-crd-installer
{{ include "gitlab.standardLabels" $ | indent 8 }}        
    spec:
      serviceAccount: {{ template "fullname" . }}-crd-installer
      restartPolicy: Never
{{- include "pullsecrets" $.Values.image | indent 6}}
      containers:
      - name: hyperkube
        image: "{{ .Values.install.image.repository }}:{{ .Values.install.image.tag }}"
        {{ template "gitlab.imagePullPolicy" . }}
        command:
        - ./kubectl
        - apply
        - -f
        - /crd/crd.yaml
        volumeMounts:
        - name: crd
          mountPath: /crd
      volumes:
      - name: crd
        configMap:
          name: {{ template "fullname" . }}-crd-installer
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "fullname" . }}-crd-installer
  labels:
{{ include "gitlab.standardLabels" $ | indent 4 }}
  annotations:
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
data:
  crd.yaml: |
    apiVersion: apiextensions.k8s.io/v1beta1
    kind: CustomResourceDefinition
    metadata:
      creationTimestamp: null
      labels:
        controller-tools.k8s.io: "1.0"
      name: gitlabs.gitlab.com
    spec:
      group: gitlab.com
      names:
        kind: GitLab
        plural: gitlabs
      scope: Namespaced
      validation:
        openAPIV3Schema:
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              properties:
                helmRelease:
                  type: string
                type:
                  type: string
                version:
                  type: string
              required:
              - version
              - type
              - helmRelease
              type: object
            status:
              type: object
          type: object
      version: v1beta1
    status:
      acceptedNames:
        kind: ""
        plural: ""
      conditions: null
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: {{ template "fullname" . }}
      labels:
{{ include "gitlab.standardLabels" $ | indent 8 }}
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      creationTimestamp: null
      name: {{ template "fullname" . }}
      labels:
{{ include "gitlab.standardLabels" $ | indent 8 }}
    rules:
    - apiGroups:
      - apps
      resources:
      - deployments
      - statefulsets
      - daemonsets
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - ""
      resources:
      - pods
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - batch
      resources:
      - jobs
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - gitlab.com
      resources:
      - gitlabs
      verbs:
      - "*"
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      creationTimestamp: null
      name: {{ template "fullname" . }}
      labels:
{{ include "gitlab.standardLabels" $ | indent 8 }}
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: {{ template "fullname" . }}
    subjects:
    - kind: ServiceAccount
      name: {{ template "fullname" . }}
      namespace: {{ .Release.Namespace | quote }}
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: {{ template "fullname" . }}
      labels:
{{ include "gitlab.standardLabels" . | indent 8 }}
    spec:
      replicas: {{ .Values.replicaCount }}
      selector:
        matchLabels:
          app: {{ template "name" . }}
          release: {{ .Release.Name }}
      template:
        metadata:
          labels:
            app: {{ template "name" . }}
            release: {{ .Release.Name }}
        spec:
          serviceAccountName: {{ template "fullname" . }}
          containers:
            - name: {{ .Chart.Name }}
              image: "{{ .Values.image.repository }}:{{ coalesce .Values.image.tag (include "gitlab.versionTag" . ) }}"
              {{ template "gitlab.imagePullPolicy" . }}
              resources:
{{ toYaml .Values.resources | indent 16 }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ template "fullname" . }}-crd-installer
  labels:
    app: {{ template "fullname" . }}-crd-installer
{{ include "gitlab.standardLabels" $ | indent 4 }}
  annotations:
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ template "fullname" . }}-crd-installer
  labels:
{{ include "gitlab.standardLabels" $ | indent 4 }}
  annotations:
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
rules:
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - "*"
- apiGroups:
  - gitlab.com
  resources:
  - gitlabs
  verbs:
  - "*"
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterroles
  - clusterrolebindings
  verbs:
  - "*"
- apiGroups:
  - ""
  resources:
  - serviceaccounts
  - pods
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - deployments
  - statefulsets
  - daemonsets
  verbs:
  - "*"
- apiGroups:
  - batch
  resources:
  - jobs
  verbs:
  - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ template "fullname" . }}-crd-installer
  labels:
{{ include "gitlab.standardLabels" $ | indent 4 }}
  annotations:
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ template "fullname" . }}-crd-installer
subjects:
  - kind: ServiceAccount
    name: {{ template "fullname" . }}-crd-installer
    namespace: {{ .Release.Namespace | quote }}
{{- end }}
